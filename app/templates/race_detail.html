{% extends "base.html" %}

{% block title %}{{ race.name }} - Corse Podistiche{% endblock %}

{% block content %}
<div class="race-detail">
    <div class="race-header">
        <h2>{{ race.name }}</h2>
        <p class="race-place">ğŸ“ {{ race.place }}</p>
    </div>
    
    <div class="race-reviews">
        <h3>Recensioni ({{ race.reviews|length }})</h3>
        
        {% if race.reviews %}
            <div class="reviews-list">
                {% for review in race.reviews %}
                    {% set avg = (review.rating_percorso_segnaletica + review.rating_percorso_fondo + review.rating_percorso_distanza + review.rating_ristori_numero + review.rating_ristori_varieta + review.rating_ristoro_abusivo + review.rating_ristoro_finale + review.rating_extra_organizzazione) / 8.0 %}
                    <div class="review-card">
                        <div class="review-summary">
                            <div class="review-header">
                                <strong>{{ review.user.username }}</strong>
                                <span class="review-route">{{ review.route }}</span>
                            </div>
                            <div class="review-average">ğŸš© {{ avg|round(1) }}/5</div>
                            <button type="button" class="btn btn-secondary toggle-details">Mostra dettagli</button>
                        </div>

                        <div class="review-details" hidden>
                            <p class="review-date">{{ review.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                            
                            <div class="review-ratings">
                                <div class="rating-group">
                                    <h4>Percorso</h4>
                                    <p>Segnaletica: ğŸš© {{ review.rating_percorso_segnaletica }}/5</p>
                                    <p>Fondo: ğŸš© {{ review.rating_percorso_fondo }}/5</p>
                                    <p>Distanza: ğŸš© {{ review.rating_percorso_distanza }}/5</p>
                                </div>
                                
                                <div class="rating-group">
                                    <h4>Ristori</h4>
                                    <p>Numero: ğŸš© {{ review.rating_ristori_numero }}/5</p>
                                    <p>VarietÃ : ğŸš© {{ review.rating_ristori_varieta }}/5</p>
                                    <p>Abusivi: ğŸš© {{ review.rating_ristoro_abusivo }}/5</p>
                                    <p>Finale: ğŸš© {{ review.rating_ristoro_finale }}/5</p>
                                </div>
                                
                                <div class="rating-group">
                                    <h4>Extra</h4>
                                    <p>Organizzazione: ğŸš© {{ review.rating_extra_organizzazione }}/5</p>
                                </div>
                            </div>
                            
                            <p class="review-content"><strong>Note:</strong> {{ review.content }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-reviews">Nessuna recensione ancora. Sii il primo a lasciarne una!</p>
        {% endif %}
        
        {% if user %}
            <div class="add-review">
                <button type="button" class="btn btn-secondary toggle-add-review">Aggiungi una Recensione</button>
                <div class="add-review-form" hidden>
                    <h4>Lascia una Recensione</h4>
                    <form method="POST" action="{{ url_for('main.add_review', race_id=race.id) }}">
                    
                    <div class="form-group">
                        <label for="route">Percorso Valutato: <span class="info-icon" data-info="percorso-valutato">â„¹ï¸</span></label>
                        <div class="info-tooltip" id="percorso-valutato" hidden>Seleziona quale distanza del percorso hai corso</div>
                        <select id="route" name="route" required>
                            <option value="">-- Seleziona un percorso --</option>
                            <option value="corto">Corto</option>
                            <option value="medio">Medio</option>
                            <option value="lungo">Lungo</option>
                        </select>
                    </div>
                    
                    <h5>Valutazione Percorso</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rating_percorso_segnaletica">Segnaletica: <span class="info-icon" data-info="segnaletica">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="segnaletica" hidden>Valuta quanto il percorso era ben segnalato</div>
                            <select id="rating_percorso_segnaletica" name="rating_percorso_segnaletica">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating_percorso_fondo">Fondo: <span class="info-icon" data-info="fondo">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="fondo" hidden>Valuta la qualitÃ  del terreno e della superficie</div>
                            <select id="rating_percorso_fondo" name="rating_percorso_fondo">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating_percorso_distanza">Distanza: <span class="info-icon" data-info="distanza">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="distanza" hidden>Valuta se la distanza dichiarata era corretta</div>
                            <select id="rating_percorso_distanza" name="rating_percorso_distanza">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                    </div>
                    
                    <h5>Valutazione Ristori</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="rating_ristori_numero">Numero: <span class="info-icon" data-info="ristori-numero">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="ristori-numero" hidden>Valuta il numero di ristori lungo il percorso</div>
                            <select id="rating_ristori_numero" name="rating_ristori_numero">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating_ristori_varieta">VarietÃ : <span class="info-icon" data-info="ristori-varieta">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="ristori-varieta" hidden>Valuta la varietÃ  di cibi e bevande offerti</div>
                            <select id="rating_ristori_varieta" name="rating_ristori_varieta">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating_ristoro_abusivo">Ristori Abusivi: <span class="info-icon" data-info="ristori-abusivi">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="ristori-abusivi" hidden>Valuta la qualitÃ  e disponibilitÃ  di ristori non ufficiali</div>
                            <select id="rating_ristoro_abusivo" name="rating_ristoro_abusivo">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rating_ristoro_finale">Ristoro Finale: <span class="info-icon" data-info="ristoro-finale">â„¹ï¸</span></label>
                            <div class="info-tooltip" id="ristoro-finale" hidden>Valuta la qualitÃ  del ristoro al traguardo</div>
                            <select id="rating_ristoro_finale" name="rating_ristoro_finale">
                                <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                                <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                                <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                                <option value="2">ğŸš©ğŸš© Scadente</option>
                                <option value="1">ğŸš© Pessimo</option>
                            </select>
                        </div>
                    </div>
                    
                    <h5>Valutazione Extra</h5>
                    <div class="form-group">
                        <label for="rating_extra_organizzazione">Organizzazione: <span class="info-icon" data-info="organizzazione">â„¹ï¸</span></label>
                        <div class="info-tooltip" id="organizzazione" hidden>Valuta l'organizzazione generale della gara e l'eventuale presenza di extra</div>
                        <select id="rating_extra_organizzazione" name="rating_extra_organizzazione">
                            <option value="5">ğŸš©ğŸš©ğŸš©ğŸš©ğŸš© Eccellente</option>
                            <option value="4">ğŸš©ğŸš©ğŸš©ğŸš© Buono</option>
                            <option value="3">ğŸš©ğŸš©ğŸš© Normale</option>
                            <option value="2">ğŸš©ğŸš© Scadente</option>
                            <option value="1">ğŸš© Pessimo</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="content">Note: <span class="info-icon" data-info="note">â„¹ï¸</span></label>
                        <div class="info-tooltip" id="note" hidden>Aggiungi commenti e osservazioni sulla tua esperienza</div>
                        <textarea 
                            id="content" 
                            name="content" 
                            rows="4" 
                            placeholder="Condividi la tua esperienza..."
                            required
                        ></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Aggiungi Recensione</button>
                    </form>
                </div>
            </div>
        {% else %}
            <p class="login-prompt"><a href="{{ url_for('main.login') }}">Accedi</a> per lasciare una recensione.</p>
        {% endif %}
    </div>
    
    <div class="race-actions">
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Torna alla Home</a>
    </div>
    
    <div class="race-info">
        <p><strong>Creato da:</strong> {{ race.creator.username }}</p>
        <p><strong>Data creazione:</strong> {{ race.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
    </div>
</div>
{% endblock %}
